//for api, check line 204 and 220
<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-50">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WalkSafe - Pavement Analyzer</title>
    
    <!-- PWA Manifest Link -->
    <link rel="manifest" href="manifest.json">
    <!-- PWA Theme Color -->
    <meta name="theme-color" content="#ffffff">
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Load Leaflet CSS (For the Map) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>

    <!-- Load Leaflet JS (For the Map) -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

    <style>
        /* Custom styles for a better mobile feel */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        /* Style for the custom file input button */
        .file-input-button {
            cursor: pointer;
        }
        /* Loading spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Ensure map has a height */
        #map {
            height: 300px;
            z-index: 0; /* Keep map below other absolute elements */
        }
    </style>
</head>
<body class="h-full antialiased text-gray-900">
    <div class="flex flex-col min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-md relative z-10">
            <div class="max-w-4xl mx-auto px-4 py-4">
                <h1 class="text-2xl font-bold text-blue-600">üåç WalkSafe</h1>
                <p class="text-gray-600">Report pavement accessibility issues with AI</p>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow max-w-4xl mx-auto p-4 w-full">
            <div class="space-y-6">
                <!-- 1. Image Upload Section -->
                <div class="bg-white p-5 rounded-lg shadow">
                    <h2 class="text-lg font-semibold mb-3">1. Upload Pavement Photo</h2>
                    
                    <!-- Custom File Input -->
                    <label for="image-upload" class="file-input-button w-full inline-block px-5 py-3 text-center bg-blue-600 text-white rounded-lg font-semibold shadow-sm hover:bg-blue-700 transition-colors">
                        Choose an image...
                    </label>
                    <input type="file" id="image-upload" class="hidden" accept="image/*" onchange="handleImageUpload(event)">
                    
                    <!-- Image Preview -->
                    <div id="image-preview-container" class="hidden mt-4">
                        <img id="image-preview" src="" alt="Image preview" class="w-full max-w-md mx-auto rounded-lg shadow-inner"/>
                    </div>
                </div>

                <!-- 2. AI Analysis Section -->
                <div id="analysis-section" class="bg-white p-5 rounded-lg shadow hidden">
                    <h2 class="text-lg font-semibold mb-3">2. AI Analysis &amp; Submission</h2>
                    
                    <!-- Analyze Button -->
                    <button id="analyze-button" onclick="analyzeImage()" class="w-full px-5 py-3 bg-green-600 text-white rounded-lg font-semibold shadow-sm hover:bg-green-700 transition-colors">
                        Analyze Pavement
                    </button>

                    <!-- Loading Indicator -->
                    <div id="loading-container" class="hidden flex flex-col items-center justify-center my-4">
                        <div class="loader"></div>
                        <p class="mt-2 text-gray-600">Analyzing image with AI... (this may take a moment)</p>
                    </div>

                    <!-- AI Results & Submission Form -->
                    <div id="results-form" class="hidden mt-4 space-y-4">
                        <p class="text-sm text-gray-600">AI has suggested the following. Please correct if needed and submit.</p>
                        
                        <!-- AI Analysis Notes -->
                        <div class="bg-gray-100 p-3 rounded-lg">
                            <h3 class="font-semibold text-sm">AI Notes:</h3>
                            <p id="ai-notes" class="text-sm text-gray-700"></p>
                        </div>
                        
                        <div>
                            <label for="issue-type" class="block text-sm font-medium text-gray-700">Identified Issue</label>
                            <input type_="text" id="issue-type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="estimated-length" class="block text-sm font-medium text-gray-700">Length (m)</label>
                                <input type="text" id="estimated-length" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="estimated-breadth" class="block text-sm font-medium text-gray-700">Breadth (m)</label>
                                <input type="text" id="estimated-breadth" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>
                        </div>

                        <!-- Lat/Long Inputs -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="latitude" class="block text-sm font-medium text-gray-700">Latitude</label>
                                <input type="text" id="latitude" placeholder="e.g. 40.7128" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="longitude" class="block text-sm font-medium text-gray-700">Longitude</label>
                                <input type="text" id="longitude" placeholder="e.g. -74.0060" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>
                        </div>
                        
                        <!-- Timestamp Input -->
                         <div>
                            <label for="image-timestamp" class="block text-sm font-medium text-gray-700">Image Timestamp</label>
                            <input type="text" id="image-timestamp" placeholder="e.g. 2023-10-27 14:30" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <p class="text-xs text-gray-500">Data extracted from text in the image (if available).</p>

                        <div>
                            <label class="block text-sm font-medium text-gray-700">AI Confidence Score</label>
                            <div id="confidence-score" class="mt-1 text-lg font-bold text-blue-600"></div>
                        </div>

                        <!-- Submit Button -->
                        <button id="submit-button" onclick="submitReport()" class="w-full px-5 py-3 bg-blue-600 text-white rounded-lg font-semibold shadow-sm hover:bg-blue-700 transition-colors">
                            Confirm & Submit Report
                        </button>
                        
                        <!-- Submission Status -->
                        <p id="submit-status" class="text-center text-green-600 font-semibold hidden"></p>
                    </div>
                </div>

                <!-- 3. Global Issue Map -->
                <div class="bg-white p-5 rounded-lg shadow">
                     <h2 class="text-lg font-semibold mb-3">3. Global Issue Map</h2>
                     <p class="text-sm text-gray-600 mb-2">Locations extracted from image data.</p>
                     <div id="map" class="border border-gray-200 rounded-lg"></div>
                </div>

                <!-- 4. Submitted Reports Section -->
                <div class="bg-white p-5 rounded-lg shadow">
                    <div class="flex justify-between items-center mb-3">
                        <h2 class="text-lg font-semibold">4. Live Report Feed</h2>
                        <button onclick="downloadCSV()" class="px-3 py-1 text-sm bg-blue-500 text-white rounded-lg shadow-sm hover:bg-blue-600 transition-colors">
                            Download CSV
                        </button>
                    </div>
                    <p class="text-sm text-gray-600 mb-4">Reports submitted by all users. (User ID: <span id="user-id" class="font-mono text-xs">loading...</span>)</p>
                    <div id="reports-list" class="space-y-3 max-h-96 overflow-y-auto">
                        <p id="reports-placeholder" class="text-gray-500">No reports submitted yet. Sign in to load...</p>
                        <!-- Reports will be injected here by JavaScript -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase services
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, collection, query, onSnapshot, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL VARIABLES ---
        let db;
        let auth;
        let currentUserId = null;
        let currentImageBase64 = null;
        let aiAnalysisResult = null;
        let allReports = []; 
        let map; // Map instance
        let mapMarkers = []; // Array to keep track of markers
        
        // --- FIREBASE CONFIG & APP ID ---
        const firebaseConfig = {
          apiKey: "", //Firebase API
          authDomain: "walksafe-1f6c9.firebaseapp.com",
          projectId: "walksafe-1f6c9",
          storageBucket: "walksafe-1f6c9.firebasestorage.app",
          messagingSenderId: "1063060269742",
          appId: "1:1063060269742:web:85cacfa32a1c643caa1b3f",
          measurementId: "G-S8SQJRHJ2E"
        };
        
        const effectiveConfig = (typeof __firebase_config !== 'undefined') 
            ? JSON.parse(__firebase_config) 
            : firebaseConfig;

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'walksafe-prototype';

        // --- GEMINI API CONFIG ---
        const apiKey = ""; //Gemini API
        const geminiModel = "gemini-2.5-flash-preview-09-2025";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${geminiModel}:generateContent?key=${apiKey}`;

        // Define the expected JSON schema for the AI response
        const geminiSchema = {
            type: "OBJECT",
            properties: {
                "issueType": { "type": "STRING", "description": "e.g., 'Cracked Pavement', 'Obstacle on Path', 'Blocked Ramp', 'Uneven Surface', 'No Issue Found', 'No Pavement'" },
                "estimatedLengthMeters": { "type": "NUMBER", "description": "Estimated length of the issue in meters. Use '0' if not applicable." },
                "estimatedBreadthMeters": { "type": "NUMBER", "description": "Estimated breadth (width) of the issue in meters. Use '0' if not applicable." },
                "latitude": { "type": "NUMBER", "description": "Latitude extracted from text in the image (e.g. timestamps/geo-stamps). Return null if not found." },
                "longitude": { "type": "NUMBER", "description": "Longitude extracted from text in the image. Return null if not found." },
                "imageTimestamp": { "type": "STRING", "description": "Timestamp extracted from text in the image (e.g., '2023-10-27 10:30:00'). Return null if not found." },
                "confidenceScore": { "type": "NUMBER", "description": "A confidence score from 0.0 to 1.0 for the overall analysis." },
                "analysisNotes": { "type": "STRING", "description": "A brief, one-sentence explanation of the finding." }
            },
            required: ["issueType", "estimatedLengthMeters", "estimatedBreadthMeters", "confidenceScore", "analysisNotes"]
        };

        // --- UI ELEMENT REFERENCES ---
        const imagePreview = document.getElementById('image-preview');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const analysisSection = document.getElementById('analysis-section');
        const analyzeButton = document.getElementById('analyze-button');
        const loadingContainer = document.getElementById('loading-container');
        const resultsForm = document.getElementById('results-form');
        const aiNotes = document.getElementById('ai-notes');
        const issueTypeInput = document.getElementById('issue-type');
        const estimatedLengthInput = document.getElementById('estimated-length');
        const estimatedBreadthInput = document.getElementById('estimated-breadth');
        const latitudeInput = document.getElementById('latitude');
        const longitudeInput = document.getElementById('longitude');
        const imageTimestampInput = document.getElementById('image-timestamp');
        const confidenceScoreDisplay = document.getElementById('confidence-score');
        const submitButton = document.getElementById('submit-button');
        const submitStatus = document.getElementById('submit-status');
        const reportsList = document.getElementById('reports-list');
        const reportsPlaceholder = document.getElementById('reports-placeholder');
        const userIdDisplay = document.getElementById('user-id');

        // --- APP INITIALIZATION ---

        function initApp() {
            try {
                if (!effectiveConfig.apiKey) {
                    throw new Error("Firebase config is missing.");
                }

                // Initialize Firebase
                const app = initializeApp(effectiveConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                setLogLevel('Debug');

                // Initialize Map
                initMap();

                // Set up auth state listener
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        userIdDisplay.textContent = currentUserId;
                        console.log("User authenticated:", currentUserId);
                        listenForReports();
                    } else {
                        currentUserId = null;
                        userIdDisplay.textContent = "Not signed in";
                        console.log("User is not authenticated.");
                    }
                });

                authenticateUser();

            } catch (e) {
                console.error("Error initializing App:", e);
                alert("Error initializing application. Check console for details.");
            }
        }

        async function authenticateUser() {
            try {
                const authToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (authToken) {
                    await signInWithCustomToken(auth, authToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Authentication failed:", error);
                userIdDisplay.textContent = "Auth Error";
            }
        }

        // --- MAP INITIALIZATION ---
        function initMap() {
            // Default view (zoom out to see world)
            map = L.map('map').setView([20, 0], 2); 

            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '¬© OpenStreetMap'
            }).addTo(map);
        }

        // --- IMAGE HANDLING ---

        window.handleImageUpload = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            resetAnalysisUI();
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    // Resize logic: Scale down image to max 800x800 to prevent API 503 errors due to large payloads
                    const MAX_WIDTH = 800;
                    const MAX_HEIGHT = 800;
                    let width = img.width;
                    let height = img.height;

                    if (width > height) {
                        if (width > MAX_WIDTH) {
                            height *= MAX_WIDTH / width;
                            width = MAX_WIDTH;
                        }
                    } else {
                        if (height > MAX_HEIGHT) {
                            width *= MAX_HEIGHT / height;
                            height = MAX_HEIGHT;
                        }
                    }

                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    // Convert to Base64 with slight compression (0.8)
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.8); 
                    currentImageBase64 = dataUrl.split(',')[1];
                    
                    // Update preview with the resized image
                    imagePreview.src = dataUrl;
                    imagePreviewContainer.classList.remove('hidden');
                    analysisSection.classList.remove('hidden');
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        };

        function resetAnalysisUI() {
            analyzeButton.disabled = false;
            analyzeButton.classList.remove('hidden');
            loadingContainer.classList.add('hidden');
            resultsForm.classList.add('hidden');
            submitButton.disabled = false;
            submitStatus.classList.add('hidden');
            aiAnalysisResult = null;
        }

        // --- GEMINI API CALL ---

        window.analyzeImage = async () => {
            if (!currentImageBase64) {
                alert("Please upload an image first.");
                return;
            }
            if (apiKey === "") {
                alert("Gemini API key is missing.");
                return;
            }

            analyzeButton.classList.add('hidden');
            loadingContainer.classList.remove('hidden');
            resultsForm.classList.add('hidden');

            const systemPrompt = `You are an AI assistant for the 'WalkSafe' app. Analyze the user's image. Look specifically for visual text stamps containing Latitude, Longitude, and Timestamp/Date-Time and extract them. Identify pavement issues. Return JSON.`;
            const userPrompt = `Analyze this image. Identify accessibility issues (e.g., 'Cracked Pavement'). Estimate Length/Breadth in meters. Extract Latitude, Longitude, and a Timestamp if they appear as text in the photo. Provide a confidence score.`;

            const payload = {
                contents: [
                    {
                        role: "user",
                        parts: [
                            { text: userPrompt },
                            {
                                inlineData: {
                                    mimeType: "image/jpeg", 
                                    data: currentImageBase64
                                }
                            }
                        ]
                    }
                ],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: geminiSchema
                }
            };
            
            try {
                // Increased default retries to 5 and improved backoff logging
                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`API request failed: ${response.status}`);

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!text) throw new Error("Invalid response structure.");

                aiAnalysisResult = JSON.parse(text);
                displayAnalysisResults(aiAnalysisResult);

            } catch (error) {
                console.error("Error analyzing image:", error);
                alert(`Error analyzing image: ${error.message}. Please try again.`);
                analyzeButton.classList.remove('hidden');
            } finally {
                loadingContainer.classList.add('hidden');
            }
        };
        
        async function fetchWithRetry(url, options, retries = 5, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) {
                        return response;
                    }
                    // Retry on 429 (Too Many Requests) or 5xx (Server Errors like 503)
                    if (response.status === 429 || response.status >= 500) {
                        const backoff = delay * Math.pow(2, i); 
                        console.warn(`Attempt ${i+1}/${retries} failed with status ${response.status}. Retrying in ${backoff}ms...`);
                        await new Promise(res => setTimeout(res, backoff));
                    } else {
                        // Do not retry 4xx errors (except 429)
                        return response;
                    }
                } catch (error) {
                    // Retry on network errors
                    const backoff = delay * Math.pow(2, i);
                    console.warn(`Attempt ${i+1}/${retries} fetch error: ${error.message}. Retrying in ${backoff}ms...`);
                    await new Promise(res => setTimeout(res, backoff));
                }
            }
            return fetch(url, options);
        }

        function displayAnalysisResults(data) {
            aiNotes.textContent = data.analysisNotes || "No notes provided.";
            issueTypeInput.value = data.issueType || "N/A";
            estimatedLengthInput.value = data.estimatedLengthMeters?.toString() || "0";
            estimatedBreadthInput.value = data.estimatedBreadthMeters?.toString() || "0";
            
            // Populate Lat/Long/Time from AI
            latitudeInput.value = data.latitude || "";
            longitudeInput.value = data.longitude || "";
            imageTimestampInput.value = data.imageTimestamp || "";

            const confidence = (data.confidenceScore || 0) * 100;
            confidenceScoreDisplay.textContent = `${confidence.toFixed(1)}%`;
            
            resultsForm.classList.remove('hidden');
        }

        // --- FIRESTORE OPERATIONS ---

        window.submitReport = async () => {
            if (!currentUserId || !aiAnalysisResult) {
                alert("Cannot submit. Not signed in or no analysis found.");
                return;
            }

            submitButton.disabled = true;
            submitStatus.textContent = "Submitting...";
            submitStatus.classList.remove('hidden', 'text-red-600');
            submitStatus.classList.add('text-yellow-600');
            
            const userIssueType = issueTypeInput.value;
            const userLength = parseFloat(estimatedLengthInput.value) || 0;
            const userBreadth = parseFloat(estimatedBreadthInput.value) || 0;
            
            // Get final Lat/Long/Time from inputs
            const userLat = parseFloat(latitudeInput.value) || null;
            const userLong = parseFloat(longitudeInput.value) || null;
            const userTimestamp = imageTimestampInput.value;

            const report = {
                userId: currentUserId,
                aiIssueType: aiAnalysisResult.issueType,
                aiLengthMeters: aiAnalysisResult.estimatedLengthMeters,
                aiBreadthMeters: aiAnalysisResult.estimatedBreadthMeters,
                aiConfidence: aiAnalysisResult.confidenceScore,
                aiNotes: aiAnalysisResult.analysisNotes,
                
                finalIssueType: userIssueType,
                finalLengthMeters: userLength,
                finalBreadthMeters: userBreadth,
                
                // Save coordinates & timestamp
                finalLatitude: userLat,
                finalLongitude: userLong,
                finalImageTimestamp: userTimestamp,
                
                userCorrected: (userIssueType !== aiAnalysisResult.issueType),
                createdAt: serverTimestamp()
            };

            try {
                const reportsCollectionPath = `/artifacts/${appId}/public/data/reports`;
                const reportsCollection = collection(db, reportsCollectionPath);
                const docRef = await addDoc(reportsCollection, report);
                
                submitStatus.textContent = "Report submitted successfully!";
                submitStatus.classList.remove('text-yellow-600');
                submitStatus.classList.add('text-green-600');
                
                setTimeout(() => {
                    resetAnalysisUI();
                    analysisSection.classList.add('hidden');
                    imagePreviewContainer.classList.add('hidden');
                    document.getElementById('image-upload').value = null; 
                    currentImageBase64 = null;
                }, 2000);
                
            } catch (error) {
                console.error("Error submitting:", error);
                submitStatus.textContent = `Error: ${error.message}`;
                submitButton.disabled = false;
            }
        };

        function listenForReports() {
            if (!db) return;
            const reportsCollectionPath = `/artifacts/${appId}/public/data/reports`;
            const q = query(collection(db, reportsCollectionPath));

            onSnapshot(q, (snapshot) => {
                if (snapshot.empty) {
                    reportsList.innerHTML = ''; 
                    reportsPlaceholder.classList.remove('hidden');
                    return;
                }

                reportsPlaceholder.classList.add('hidden');
                let reports = [];
                snapshot.forEach(doc => {
                    reports.push({ id: doc.id, data: doc.data() });
                });
                
                reports.sort((a, b) => {
                    const timeA = a.data.createdAt?.seconds || 0;
                    const timeB = b.data.createdAt?.seconds || 0;
                    return timeB - timeA;
                });

                allReports = reports; 
                renderReports(reports);
                updateMapMarkers(reports); // Update map

            }, (error) => {
                console.error("Error listening to reports:", error);
            });
        }

        function updateMapMarkers(reports) {
            if (!map) return;

            // Clear existing markers
            mapMarkers.forEach(marker => marker.remove());
            mapMarkers = [];

            let validCoords = [];

            reports.forEach(report => {
                const data = report.data;
                if (data.finalLatitude && data.finalLongitude) {
                    const marker = L.marker([data.finalLatitude, data.finalLongitude])
                        .bindPopup(`<b>${data.finalIssueType}</b><br>Length: ${data.finalLengthMeters}m`)
                        .addTo(map);
                    mapMarkers.push(marker);
                    validCoords.push([data.finalLatitude, data.finalLongitude]);
                }
            });

            // If we have markers, zoom map to fit them
            if (validCoords.length > 0) {
                const bounds = L.latLngBounds(validCoords);
                map.fitBounds(bounds, { padding: [50, 50] });
            }
        }

        function renderReports(reports) {
            reportsList.innerHTML = ''; 
            reports.forEach(reportDoc => {
                const data = reportDoc.data;
                const date = data.createdAt ? new Date(data.createdAt.seconds * 1000).toLocaleString() : 'Just now';
                
                const coords = (data.finalLatitude && data.finalLongitude) 
                    ? `<p class="text-xs text-blue-600 mt-1">üìç ${data.finalLatitude.toFixed(4)}, ${data.finalLongitude.toFixed(4)}</p>`
                    : '';
                
                const imgTime = data.finalImageTimestamp 
                    ? `<p class="text-xs text-purple-600 mt-1">üïí Image Time: ${data.finalImageTimestamp}</p>` 
                    : '';

                const reportEl = document.createElement('div');
                reportEl.className = 'border border-gray-200 p-3 rounded-lg bg-gray-50';
                const breadthText = data.finalBreadthMeters !== undefined ? `x ${data.finalBreadthMeters}m (B)` : '';
                
                reportEl.innerHTML = `
                    <p class="font-semibold text-blue-700">${data.finalIssueType}</p>
                    <p class="text-sm text-gray-800">Dimensions: ${data.finalLengthMeters}m (L) ${breadthText}</p>
                    ${coords}
                    ${imgTime}
                    <p class="text-xs text-gray-500 mt-1">Reported: ${date}</p>
                    ${data.userCorrected ? '<span class="text-xs mt-1 inline-block bg-yellow-200 text-yellow-800 px-2 py-0.5 rounded-full">User Corrected AI</span>' : ''}
                `;
                reportsList.appendChild(reportEl);
            });
        }

        // --- CSV Download ---
        function escapeCSV(cell) {
            if (cell === undefined || cell === null) return '';
            let str = String(cell);
            if (str.includes(',') || str.includes('\n') || str.includes('"')) {
                str = str.replace(/"/g, '""');
                return `"${str}"`;
            }
            return str;
        }

        window.downloadCSV = () => {
            if (allReports.length === 0) {
                alert("No reports to download.");
                return;
            }
            const headers = [
                "UserID", "Timestamp", "IssueType", "Length (m)", "Breadth (m)", 
                "Latitude", "Longitude", "Image Timestamp", // Added field
                "AI IssueType", "AI Length (m)", "AI Breadth (m)", "AI Confidence", "AI Notes"
            ];

            let csvContent = headers.join(",") + "\n";
            allReports.forEach(reportDoc => {
                const data = reportDoc.data;
                const timestamp = data.createdAt ? new Date(data.createdAt.seconds * 1000).toISOString() : "N/A";
                const row = [
                    data.userId, timestamp, data.finalIssueType, data.finalLengthMeters, data.finalBreadthMeters,
                    data.finalLatitude, data.finalLongitude, data.finalImageTimestamp, // Added field
                    data.aiIssueType, data.aiLengthMeters, data.aiBreadthMeters, data.aiConfidence, data.aiNotes
                ];
                csvContent += row.map(escapeCSV).join(",") + "\n";
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "walksafe_reports.csv";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        // --- PWA Registration ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(reg => console.log('SW registered:', reg.scope))
                    .catch(err => console.log('SW registration failed:', err));
            });
        }

        // --- START ---
        initApp();

    </script>
</body>
</html>
